<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Kabadi Techno Poster</title>
  <!-- Include html2canvas library for image capture -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #eaeaea;
    }

    .poster {
      width: 595px;
      height: 842px;
      margin: 30px auto;
      background: url('/media/marketplace/QRs/poster1.png') no-repeat center top;
      background-size: cover;
      position: relative;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
    }

    #dynamic-qr {
      position: absolute;
      bottom: 90px; /* Positioned above "JOIN US NOW" text */
      right: 15px;
      width: 110px;
      height: 110px;
      background: white;
      padding: 4px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      border: 2px solid #2E7D32;
    }

    .dealer-name {
      position: absolute;
      bottom: 720px; /* Positioned above "What We Do" text */
      right: 10px; /* Align with the right side content */
      left: auto;
      width: 150px; /* Fixed width for better control */
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: white; /* Golden yellow color to match the poster */
      text-transform: capitalize;
      letter-spacing: 0.5px;
      line-height: 1.2;
      padding: 6px 10px;
      background: rgba(46, 125, 50, 0.9); /* Dark green background */
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      border: 1px solid #FFD700;
    }

    .qr-error {
      position: absolute;
      bottom: 90px;
      right: 15px;
      width: 110px;
      height: 110px;
      background: white;
      padding: 4px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      border: 2px solid #ff6b6b;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 10px;
      color: #ff0000;
    }

    .footer-text {
      position: absolute;
      bottom: 60px;
      right: 65px;
      font-size: 12px;
      font-weight: bold;
      color: white;
    }

    .download-btn {
      position: absolute;
      bottom: 70px; /* Just above "support to local kabadiwalas" text */
      left: 220px;
      background: linear-gradient(135deg, #FFD700 0%, #FFA000 100%);
      color: #2E7D32;
      padding: 10px 20px;
      border: none;
      border-radius: 25px;
      font-size: 14px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(255, 215, 0, 0.4);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      min-width: 140px;
      justify-content: center;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 215, 0, 0.6);
      background: linear-gradient(135deg, #FFA000 0%, #FFD700 100%);
    }

    .download-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(255, 215, 0, 0.4);
    }

    .download-icon {
      font-size: 16px;
    }
  </style>
</head>
<body>

  <div class="poster">
    <!-- Display Dealer Name -->
    <div class="dealer-name">{{ dealer_name|title }}</div>
    
    <!-- Download Button -->
    <button class="download-btn" onclick="downloadPoster()">
      <span class="download-icon">‚¨á</span>
      <span>Download</span>
    </button>
    
    <!-- Dynamic QR Code from Marketplace -->
    {% if marketplace.qrCode %}
      <img id="dynamic-qr" src="{{ marketplace.qrCode.url }}" alt="QR Code for {{ dealer_name }}" />
    {% elif marketplace.url %}
      <img id="dynamic-qr" src="https://api.qrserver.com/v1/create-qr-code/?data={{ marketplace.url|urlencode }}&size=200x200" alt="QR Code for {{ dealer_name }}" />
    {% else %}
      <div class="qr-error">
        <div style="font-size: 20px;">üì±</div>
        <div>QR Code</div>
        <div>Not Available</div>
      </div>
    {% endif %}
    
  </div>

  <script>
    // Download poster as JPG functionality
    function downloadPoster() {
      const posterElement = document.querySelector('.poster');
      const dealerName = '{{ dealer_name|escapejs }}';
      const downloadBtn = document.querySelector('.download-btn');
      
      // Hide download button temporarily
      if (downloadBtn) {
        downloadBtn.style.display = 'none';
      }
      
      // Show loading state
      const originalText = downloadBtn ? downloadBtn.innerHTML : '';
      if (downloadBtn) {
        downloadBtn.style.display = 'flex';
        downloadBtn.innerHTML = '<span>üì•</span><span>Generating...</span>';
        downloadBtn.disabled = true;
      }
      
      // Wait a moment for the button to hide, then capture
      setTimeout(() => {
        // Hide button again for capture
        if (downloadBtn) {
          downloadBtn.style.display = 'none';
        }
        
        // Configure html2canvas options for better quality
        const options = {
          allowTaint: true,
          useCORS: true,
          scale: 2, // Higher resolution
          width: 595,
          height: 842,
          backgroundColor: null,
          logging: false,
          onclone: function(clonedDoc) {
            // Ensure images are loaded in the cloned document
            const clonedPoster = clonedDoc.querySelector('.poster');
            if (clonedPoster) {
              clonedPoster.style.transform = 'none';
            }
          }
        };
        
        // Capture the poster element
        html2canvas(posterElement, options).then(function(canvas) {
          // Convert canvas to JPG blob
          canvas.toBlob(function(blob) {
            // Create download link
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // Set filename with dealer name and timestamp
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `${dealerName.replace(/[^a-zA-Z0-9]/g, '_')}_Kabadi_Techno_Poster_${timestamp}.jpg`;
            
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Cleanup
            URL.revokeObjectURL(url);
            
            // Restore download button
            if (downloadBtn) {
              downloadBtn.style.display = 'flex';
              downloadBtn.innerHTML = originalText;
              downloadBtn.disabled = false;
            }
            
            // Show success message briefly
            if (downloadBtn) {
              const successText = '<span>‚úÖ</span><span>Downloaded!</span>';
              downloadBtn.innerHTML = successText;
              setTimeout(() => {
                downloadBtn.innerHTML = originalText;
              }, 2000);
            }
            
          }, 'image/jpeg', 0.95); // 95% quality JPG
          
        }).catch(function(error) {
          console.error('Error generating image:', error);
          
          // Restore download button on error
          if (downloadBtn) {
            downloadBtn.style.display = 'flex';
            downloadBtn.innerHTML = '<span>‚ùå</span><span>Error</span>';
            downloadBtn.disabled = false;
            
            setTimeout(() => {
              downloadBtn.innerHTML = originalText;
            }, 3000);
          }
          
          // Fallback to print method
          alert('Image generation failed. Please try again or use browser print function.');
        });
      }, 100);
    }

    // Add some interactive effects
    document.addEventListener('DOMContentLoaded', function() {
      const qrElement = document.querySelector('#dynamic-qr');
      const dealerNameElement = document.querySelector('.dealer-name');
      const downloadBtn = document.querySelector('.download-btn');
      
      if (qrElement) {
        qrElement.addEventListener('mouseenter', function() {
          this.style.transform = 'scale(1.1)';
          this.style.transition = 'transform 0.3s ease';
        });

        qrElement.addEventListener('mouseleave', function() {
          this.style.transform = 'scale(1)';
        });
      }
      
      // Add subtle animation to dealer name
      if (dealerNameElement) {
        dealerNameElement.addEventListener('mouseenter', function() {
          this.style.background = 'rgba(46, 125, 50, 1)';
          this.style.transform = 'scale(1.05)';
          this.style.transition = 'all 0.3s ease';
        });
        
        dealerNameElement.addEventListener('mouseleave', function() {
          this.style.background = 'rgba(46, 125, 50, 0.9)';
          this.style.transform = 'scale(1)';
        });
      }

      // Download button animation
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          if (!this.disabled) {
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
              this.style.transform = 'scale(1)';
            }, 150);
          }
        });
      }
    });
  </script>

</body>
</html>
